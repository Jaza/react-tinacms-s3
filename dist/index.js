!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react-final-form"),require("@tinacms/react-core"),require("@tinacms/react-modals"),require("react"),require("@tinacms/styles"),require("@tinacms/fields"),require("styled-components"),require("aws-sdk/clients/s3"),require("js-cookie"),require("aws-sdk")):"function"==typeof define&&define.amd?define(["exports","react-final-form","@tinacms/react-core","@tinacms/react-modals","react","@tinacms/styles","@tinacms/fields","styled-components","aws-sdk/clients/s3","js-cookie","aws-sdk"],t):t((e=e||self)["react-tinacms-s3"]={},e.reactFinalForm,e.reactCore,e.reactModals,e.React,e.styles,e.fields,e.styled,e.S3,e.Cookies,e.aws)}(this,function(e,r,c,i,a,o,s,t,n,u,l){"use strict";var d="default"in a?a.default:a;t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,n=n&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n,u=u&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u,l=l&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l;var f=function(){return(f=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function m(o,s,c,a){return new(c=c||Promise)(function(e,t){function n(e){try{i(a.next(e))}catch(e){t(e)}}function r(e){try{i(a.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new c(function(e){e(t.value)}).then(n,r)}i((a=a.apply(o,s||[])).next())})}function h(n,r){var i,o,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,o=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){c.label=t[1];break}if(6===t[0]&&c.label<s[1]){c.label=s[1],s=t;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(t);break}s[2]&&c.ops.pop(),c.trys.pop();continue}t=r.call(n,c)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function p(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function y(e){var t=this,r=e.onAuthSuccess,n=e.close,i=c.useCMS(),o=a.useState(),e=o[0],s=(o[1],i.api.s3Sts);return d.createElement(b,{title:"AWS Access Key",message:"Access S3 with your AWS credentials.",close:n,actions:[]},d.createElement(v,{close:n,onAuthSuccess:r,error:e,onSubmit:function(n){return m(t,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,s.authenticate(n.accessKeyId,n.secretAccessKey)];case 1:return e.sent(),r(),[3,3];case 2:return t=e.sent(),i.events.dispatch({type:"s3:error",error:t}),[3,3];case 3:return[2]}})})}}))}function v(e){var t=e.onSubmit,n=e.close,e=e.error;return d.createElement(w,null,d.createElement("strong",null,e),d.createElement(r.Form,{onSubmit:t,render:function(e){e=e.handleSubmit;return d.createElement("form",{onSubmit:e},d.createElement(r.Field,{name:"accessKeyId",render:function(e){e=e.input;return d.createElement(S,null,d.createElement("label",null,d.createElement("p",null,"Access Key ID"),d.createElement(s.Input,f({},e))))}}),d.createElement(r.Field,{name:"secretAccessKey",render:function(e){e=e.input;return d.createElement(S,null,d.createElement("label",null,d.createElement("p",null,"Secret Access Key"),d.createElement(s.Input,f({type:"password"},e))))}}),d.createElement(i.ModalActions,null,d.createElement(o.Button,{type:"button",onClick:n},"Close"),d.createElement(o.Button,{primary:!0,type:"submit"},"Submit")))}}))}function b(e){return d.createElement(i.Modal,null,d.createElement(i.ModalPopup,null,d.createElement(i.ModalHeader,{close:e.close},e.title),d.createElement(i.ModalBody,{padded:!0},d.createElement("p",null,e.message),e.children)))}var w=t.div.withConfig({displayName:"FormWrapper",componentId:"sc-k30jte"})(p(["\n  padding: 1rem;\n  border-radius: 3rem;\n"],["\n  padding: 1rem;\n  border-radius: 3rem;\n"])),S=t.div.withConfig({displayName:"InputWrapper",componentId:"sc-pge46o"})(p(["\n  padding-bottom: 1rem;\n"],["\n  padding-bottom: 1rem;\n"])),g="tina_s3_session_token",E=(Object.defineProperty(k.prototype,"sessionToken",{get:function(){return u.get(g)||""},set:function(e){u.set(g,e)},enumerable:!1,configurable:!0}),k.prototype.authenticate=function(n,r){return m(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:return t=O(this.s3Bucket),[4,C(n,r,this.region,t)];case 1:if(!(t=e.sent()).Credentials)throw new Error("token is missing required Credentials attribute");return this.sessionToken=t.Credentials.SessionToken,[2]}})})},k);function k(e,t){var n,r={region:e,s3Bucket:t};for(n in r)if(!r[n])throw new Error("Missing "+n+" in S3StsClient constructor");this.region=e,this.s3Bucket=t}var O=function(e){return{Statement:[{Sid:"S3ListAssets",Effect:"Allow",Action:["s3:ListBucket"],Resource:["arn:aws:s3:::"+e]},{Sid:"S3CrudAssets",Effect:"Allow",Action:["s3:DeleteObject","s3:PutObject","s3:PutObjectAcl"],Resource:["arn:aws:s3:::"+e+"/*"]}]}},C=function(n,r,i,o){return m(void 0,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:return t={accessKeyId:n,secretAccessKey:r,region:i},[4,new l.STS(t).getFederationToken({Name:"S3UploadWebToken",Policy:JSON.stringify(o),DurationSeconds:43200}).promise()];case 1:return[2,e.sent()]}})})},t=(A.prototype.persist=function(s){return m(this,void 0,void 0,function(){var t,n,r,i,o;return h(this,function(e){switch(e.label){case 0:t=[],n=0,r=s,e.label=1;case 1:return n<r.length?(o=r[n],i=o.directory,o=o.file,[4,K(this.s3Bucket,i,o,this.s3ServerSideEncryption)]):[3,4];case 2:o=e.sent(),t.push(R(o,this.s3ReadUrl)),e.label=3;case 3:return n++,[3,1];case 4:return[2,t]}})})},A.prototype.previewSrc=function(t){return m(this,void 0,void 0,function(){return h(this,function(e){return[2,this.s3ReadUrl+(this.s3ReadUrl.endsWith("/")?"":"/")+t.replace(/^\/+/,"")]})})},A.prototype.list=function(f){var p;return m(this,void 0,void 0,function(){var t,n,r,i,o,s,c,a,u,l,d;return h(this,function(e){switch(e.label){case 0:return i=null!==(p=null==f?void 0:f.directory)&&void 0!==p?p:"",t=null!==(p=null==f?void 0:f.offset)&&void 0!==p?p:0,n=null!==(p=null==f?void 0:f.limit)&&void 0!==p?p:1e3,r=[],[4,j(this.s3Bucket,i)];case 1:if((a=e.sent()).CommonPrefixes)for(i=a.CommonPrefixes,o=0,s=i;o<s.length;o++)c=s[o],r.push(M(c));if(a.Contents)for(a=a.Contents,u=0,l=a;u<l.length;u++)d=l[u],r.push(R(d,this.s3ReadUrl));return[2,{items:r,offset:t,limit:n,totalCount:r.length}]}})})},A.prototype.delete=function(t){return m(this,void 0,void 0,function(){return h(this,function(e){switch(e.label){case 0:return[4,x(this.s3Bucket,t.id)];case 1:return e.sent(),[2]}})})},A);function A(e){var t=e.s3Bucket,n=e.s3ReadUrl,n=void 0===n?"":n,e=e.s3ServerSideEncryption,e=void 0===e?"":e;this.accept="*",this.s3Bucket=t,this.s3ReadUrl=null!=n?n:"//"+t+"."+P,this.s3ServerSideEncryption=e}var P="s3.amazonaws.com",j=function(r,i){return m(void 0,void 0,void 0,function(){var t,n;return h(this,function(e){switch(e.label){case 0:return t=B(),n=i.replace(/^\//,"").replace(/\/$/,""),n={Bucket:r,Delimiter:"/",Prefix:n+(n?"/":"")},[4,t.listObjectsV2(n).promise()];case 1:return[2,e.sent()]}})})},K=function(o,s,c,a){return m(void 0,void 0,void 0,function(){var t,n,r,i;return h(this,function(e){switch(e.label){case 0:return t=encodeURIComponent(c.name),n=B(),[4,q(c)];case 1:return i=e.sent(),r=s.replace(/^\//,"").replace(/\/$/,"")+"/"+t.replace(/\s/g,"-"),i={ACL:"public-read",Bucket:o,Key:r,Body:i,CacheControl:"max-age=630720000, public",ContentType:c.type},a&&(i.ServerSideEncryption=a),[4,n.upload(i).promise()];case 2:return[2,e.sent()]}})})},x=function(r,i){return m(void 0,void 0,void 0,function(){var t,n;return h(this,function(e){switch(e.label){case 0:return t=B(),n={Bucket:r,Key:i},[4,t.deleteObject(n).promise()];case 1:return e.sent(),[2]}})})},B=function(){var e=I();if(!e)throw new Error("session token is required");return new n({sessionToken:e})},I=function(){return u.get(g)||""},q=function(n){return new Promise(function(t){var e=new FileReader;e.onload=function(e){t(null===(e=e.target)||void 0===e?void 0:e.result)},e.readAsArrayBuffer(n)})},M=function(e){if(!e.Prefix)throw new Error("item is missing required Prefix attribute");e=e.Prefix.substr(0,e.Prefix.lastIndexOf("/"));return{id:e,filename:e,directory:"",type:"dir"}},R=function(e,t){if(!e.Key)throw new Error("item is missing required Key attribute");var n=e.Key.substr(0,e.Key.lastIndexOf("/")),r=e.Key.substr(e.Key.lastIndexOf("/")+1),i=e.Key.substr(e.Key.lastIndexOf(".")+1),e={id:e.Key,filename:r,directory:n,type:"file"};return["jpg","jpeg","png","webp","svg"].includes(i.toLowerCase())&&(e.previewSrc=t+(t.endsWith("/")?"":"/")+n+(n?"/":"")+r),e};e.ModalBuilder=b,e.S3AuthForm=v,e.S3AuthModal=y,e.S3MediaStore=t,e.S3Provider=function(e){var t=e.children,n=e.onLogin,r=e.onLogout,i=a.useState("none"),e=i[0],o=i[1];return c.useCMSEvent("cms:enable",function(){o("authenticate")},[]),c.useCMSEvent("cms:disable",r,[]),d.createElement(d.Fragment,null,"authenticate"===e&&d.createElement(y,{close:function(){o("none")},onAuthSuccess:function(){n(),o("none")}}),t)},e.S3StsClient=E,e.S3_SESSION_TOKEN=g,Object.defineProperty(e,"__esModule",{value:!0})});
